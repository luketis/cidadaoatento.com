/*
 * Copyright (C) 2014 Pedro Maia (pedro@pedromm.com)
 *
 * This file is part of Cidad達o Atento.
 * 
 * Cidad達o Atento is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * Cidad達o Atento is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with Cidad達o Atento.  If not, see <http://www.gnu.org/licenses/>.
 */
 $(document).ready(function(){function p(){e=new google.maps.LatLng(-19.9634,-44.1995);b.setCenter(e)}function l(){$(".nav-top").fadeIn("slow")}function q(a){google.maps.event.trigger(m[a],"click")}var e,n,g=0,h=!1,j=!1,r=!1,t={zoom:15,maxZoom:17,minZoom:5,mapTypeControl:!1,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0},b=new google.maps.Map(document.getElementById("mapa"),t),s=new google.maps.Geocoder,k=[],m=[],o=null,d=$("meta[name=csrf]").attr("content");novaCSRF=
function(){$.getJSON("/seguranca/get_new",function(a){d=a.token})};document.createElement("div");navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){e=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);b.setCenter(e);marcaLocalCidadao()},function(){p()}):google.gears?google.gears.factory.create("beta.geolocation").getCurrentPosition(function(a){e=new google.maps.LatLng(a.latitude,a.longitude);b.setCenter(e);marcaLocalCidadao()},function(){handleNoGeoLocation()}):p();
marcaLocalCidadao=function(){if(!r){var a=new google.maps.MarkerImage("/web-dir/img/ui-marcador-pessoa.png",null,null,new google.maps.Point(0,16),new google.maps.Size(22,32)),c=new google.maps.Marker({position:e,map:b,icon:a,title:"Voc\u00ea"});google.maps.event.addListener(c,"click",function(){b.setZoom(17);b.setCenter(c.position);_gaq.push(["_trackEvent","Cidad\u00e3o","Local",codigo])});k.push(c);r=!0;$(window).hashChange(q)}};carregaDenuncias=function(){k=[];m=[];$.post("/denuncias/listaClusterer",
{csrfTest:d,post:"true"},function(a){o=a;for(a=0;a<o.count;a++){var c=o.denuncias[a],f=new google.maps.MarkerImage("/web-dir/upload/"+c.img,null,null,new google.maps.Point(32,32),new google.maps.Size(60,60)),f=new google.maps.Marker({position:new google.maps.LatLng(c.lat,c.lng),map:b,icon:f,title:c.nome});addMarker(f,c.codigo);m[c.codigo]=f;k.push(f)}new MarkerClusterer(b,k)});_gaq.push(["_trackEvent","Den\u00fancias","Carregar","Todas"]);novaCSRF()};carregaDenuncias();addMarker=function(a,c){google.maps.event.addListener(a,
"click",function(){carregaDenuncia(c);b.setZoom(17);b.setCenter(a.position);_gaq.push(["_trackEvent","Den\u00fancias","Ver",c])})};$("#close-box-click").click(function(){$(".denuncia-box").fadeOut("slow")});$(".denuncia-box").hide();carregaDenuncia=function(a){$(".denuncia-box").fadeIn("slow");$("#carregando-denuncia").show();$("#conteudo-denuncia").hide();$.post("/denuncias/carrega",{csrfTest:d,codigo:a},function(a){$(".denuncia-box .tipo").html(a.descricao_tipo);$(".denuncia-box .data").html("Registrado dia "+
a.data_add);$(".denuncia-box .foto").attr("src","/web-dir/upload/"+a.foto+"_thumb."+a.ext).attr("alt",a.descricao_tipo);$(".denuncia-box blockquote").html(a.descricao_denuncia);$("#reportarDenuncia").attr("href","javascript:reportarDenuncia("+a.codigo+");");$("#apoiarDenuncia").attr("href","javascript:apoiarDenuncia("+a.codigo+");");$("#totalApoios").html(a.numero_apoios);!1==a.pode_reportar?$("#reportarDenuncia").attr("class","btn btn-danger btn-mini disabled"):$("#reportarDenuncia").attr("class",
"btn btn-danger btn-mini");!1==a.pode_apoiar?$("#apoiarDenuncia").attr("class","btn btn-success btn-mini disabled"):$("#apoiarDenuncia").attr("class","btn btn-success btn-mini");$("#urlShort").val(a.url);$("#conteudo-denuncia").show();$("#carregando-denuncia").hide()});_gaq.push(["_trackEvent","Den\u00fancias","Carrega",a]);novaCSRF()};reportarDenuncia=function(a){$("#reportarDenuncia").hasClass("btn btn-danger btn-mini disabled")||($.post("/denuncias/reportar",{csrfTest:d,token:g,codigo:a},function(){}).success(function(){$("#dialog-reporte-adicionado").dialog("open")}).error(function(){$("#dialog-erro").dialog("open")}),
carregaDenuncia(a),_gaq.push(["_trackEvent","Den\u00fancias","Reportar",a]),novaCSRF())};apoiarDenuncia=function(a){$("#apoiarDenuncia").hasClass("btn btn-success btn-mini disabled")||($.post("/denuncias/apoiar",{csrfTest:d,token:g,codigo:a},function(){}),carregaDenuncia(a),_gaq.push(["_trackEvent","Den\u00fancias","Apoiar",a]),novaCSRF())};$(".nav-terminar").hide();$("#procurar-query").autocomplete({source:function(a,c){_gaq.push(["_trackEvent","Den\u00fancias","Procurar",a]);s.geocode({address:a.term},
function(a){c($.map(a,function(a){return{label:a.formatted_address,value:a.formatted_address,latitude:a.geometry.location.lat(),longitude:a.geometry.location.lng()}}))})},select:function(a,c){_gaq.push(["_trackEvent","Den\u00fancias","Procurar-click",c.item.formatted_address]);b.setCenter(location)}});$("#procurar-query-dois").autocomplete({source:function(a,c){_gaq.push(["_trackEvent","Den\u00fancias","Procurar",a]);s.geocode({address:a.term},function(a){c($.map(a,function(a){return{label:a.formatted_address,
value:a.formatted_address,latitude:a.geometry.location.lat(),longitude:a.geometry.location.lng()}}))})},select:function(a,c){_gaq.push(["_trackEvent","Den\u00fancias","Procurar-click",c.item.formatted_address]);var f=new google.maps.LatLng(c.item.latitude,c.item.longitude);b.setCenter(f)}});$("#cancela-denuncia-click").click(function(){$(".nav-terminar").hide();l();b.setOptions({draggableCursor:"url(http://maps.google.com/mapfiles/openhand.cur), move"});h=!1;_gaq.push(["_trackEvent","Den\u00fancias",
"Cancela"])});$("#registra-denuncia-click").click(function(){$.getJSON("/cidadaos/validaSession",function(a){_gaq.push(["_trackEvent","Den\u00fancias","Adicionar"]);g=a.token;$(".nav-top").fadeOut("slow");0!=a.erro?(h=!0,b.setOptions({draggableCursor:"crosshair"}),$(".nav-terminar").show(),$("#telefone").mask("(99) 9999-9999"),$("#cpf").mask("999.999.999-99"),$("#dialog-login").dialog("open"),$("#welcome").validate({errorLabelContainer:$("#welcome .error"),rules:{cpf:{required:!0,verificaCPF:!0},
telefone:{required:!0,minlength:14},termos:"required"},messages:{cpf:{required:"Preencha o seu CPF.<br />",verificaCPF:"Use um CPF v\u00e1lido.<br />"},telefone:"Preencha o seu telefone.<br />",termos:"Voc\u00ea deve aceitar os nossos termos.<br />"}}),$.validator.addMethod("verificaCPF",function(a){a=a.replace(".","");a=a.replace(".","");for(cpf=a.replace("-","");11>cpf.length;)cpf="0"+cpf;var a=/^0+$|^1+$|^2+$|^3+$|^4+$|^5+$|^6+$|^7+$|^8+$|^9+$/,b=[],d=new Number,e=11;for(i=0;11>i;i++)b[i]=cpf.charAt(i),
9>i&&(d+=b[i]*--e);b[9]=2>(x=d%11)?0:11-x;d=0;e=11;for(y=0;10>y;y++)d+=b[y]*e--;b[10]=2>(x=d%11)?0:11-x;return cpf.charAt(9)!=b[9]||cpf.charAt(10)!=b[10]||cpf.match(a)?!1:!0},"Informe um CPF v\u00e1lido.")):0!=a.erro?($("#dialog-erro").dialog("open"),h=!1):(h=!0,$(".nav-terminar").show(),b.setOptions({draggableCursor:"crosshair"}))})});google.maps.event.addListener(b,"click",function(a){n=a.latLng;h&&$.post("/cidadaos/podeDenunciar",{csrfTest:d,token:g},function(a){switch(a.erro){case 4:$("#dialog-erro-limite").dialog("open");
break;case 0:$("#dialog-add-denuncia").dialog("open");break;default:$("#dialog-erro").dialog("open")}},"json");novaCSRF()});$("#dialog:ui-dialog").dialog("destroy");$("#dialog-add-denuncia").dialog({autoOpen:!1,height:350,width:340,modal:!0,draggable:!1,resizable:!1,show:"fold",open:function(){$("#foto").replaceWith($("#foto").clone(!0));$("#descricao").val("")},buttons:{Enviar:function(){$("#upload_form").validate({errorLabelContainer:$("#upload_form .error"),rules:{descricao:"required",foto:{required:!0,
accept:"gif|jpg|png"}},messages:{foto:{required:"Voc\u00ea deve enviar uma foto junto com a den\u00fancia.<br />",accept:"Formato de foto inv\u00e1lido.<br />"},descricao:"Voc\u00ea deve fazer um breve coment\u00e1rio sobre a den\u00fancia.<br />"}});$("#upload_form").valid()&&($("#upload_form").submit(),$("#dialog-carregando").dialog("open"),$("#upload_to").load(function(){var a=$.parseJSON($(this).contents().text());null!=a&&$.post("/denuncias/adicionar",{csrfTest:d,lat:n.lat(),lng:n.lng(),tip:$("#tipo").val(),
descricao:$("#descricao").val(),fot:a.html},function(){}).complete(function(){$("#dialog-carregando").dialog("close");$("#dialog-adicionado").dialog("open");carregaDenuncias();novaCSRF()})}),$(this).dialog("close"))},Cancelar:function(){$(this).dialog("close")}},close:function(){$(this).dialog("close")}});$("#contato-click").click(function(){$("#dialog-contato").dialog("open");_gaq.push(["_trackEvent","Contato","Abrir"])});$("#dialog-contato").dialog({autoOpen:!1,height:460,width:450,modal:!0,draggable:!1,
resizable:!1,show:"fold",open:function(){$(".ui-dialog-titlebar-close ui-corner-all").attr("href","javascript:void(0)")},buttons:{Enviar:function(){$("#contato").validate({errorLabelContainer:$("#contato .error"),rules:{"nome-contato":{required:!0,minlength:10},"email-contato":{required:!0,email:!0},"assunto-contato":{required:!0,minlength:10},"texto-contato":{required:!0,minlength:30}},messages:{"nome-contato":{required:"Digite seu nome. <br />",minlength:"O seu nome deve conter mais que 10 caracteres. <br />"},
"email-contato":{required:"Digite um email. <br />",email:"Digite um email v\u00e1lido. <br />"},"assunto-contato":{required:"Digite um assunto. <br />",minlength:"O assunto deve conter mais que 10 caracteres. <br />"},"texto-contato":{required:"Digite uma mensagem. <br />",minlength:"A mensagem deve conter mais que 30 caracteres. <br/>"}}});$("#contato").valid()&&$.post("/ticket/novo",{csrfTest:d,nome:$("#nome-contato").val(),email:$("#email-contato").val(),assunto:$("#assunto-contato").val(),texto:$("#texto-contato").val()},
function(a){switch(a.erro){case 0:$("#dialog-ticket-enviado").dialog("open");$("#nome-contato").val("");$("#email-contato").val("");$("#assunto-contato").val("");$("#texto-contato").val("");break;default:$("#dialog-erro").dialog("open")}$("#dialog-contato").dialog("close");novaCSRF()})},Cancelar:function(){$(this).dialog("close")}},close:function(){$(this).dialog("close")}});$("#dialog-adicionado").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,resizable:!1,show:"fold",hide:"fold",buttons:{Ok:function(){$(this).dialog("close")}}});
$("#dialog-erro").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,resizable:!1,show:"fold",hide:"fold",buttons:{Ok:function(){$(this).dialog("close")}}});$("#dialog-ticket-enviado").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,resizable:!1,show:"fold",hide:"fold",buttons:{Ok:function(){$(this).dialog("close")}}});$("#dialog-usuario-telefone").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,resizable:!1,show:"fold",hide:"fold",buttons:{Ok:function(){$(this).dialog("close")}}});
$("#dialog-erro-limite").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,resizable:!1,show:"fold",hide:"fold",buttons:{Ok:function(){$(this).dialog("close")}}});$("#dialog-logado").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,resizable:!1,show:"fold",hide:"fold",buttons:{Ok:function(){$(this).dialog("close")}}});$("#dialog-reporte-adicionado").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,resizable:!1,show:"fold",hide:"fold",buttons:{Ok:function(){$(this).dialog("close")}}});
$("#dialog-login").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,minHeight:500,resizable:!1,show:"fold",hide:"fold",close:function(){j||($(".nav-terminar").hide(),l())},buttons:{Enviar:function(){$("#welcome").valid()&&$.post("/cidadaos/login",{csrfTest:d,cpf:$("#cpf").val(),telefone:$("#telefone").val()},function(a){g=a.token;switch(a.erro){case 3:$("#dialog-usuario-telefone").dialog("open");j=!1;break;case 0:$("#dialog-login").dialog("close");$("#dialog-logado").dialog("open");j=!0;break;
default:$("#dialog-erro").dialog("open"),j=!1}novaCSRF()},"json")},Cancelar:function(){$(this).dialog("close");$(".nav-terminar").hide();l()}}});$("#dialog-carregando").dialog({height:140,modal:!0,autoOpen:!1,draggable:!1,resizable:!1,height:85,show:"fold",hide:"fold",closeOnEscape:!1,open:function(){$(".ui-dialog-titlebar-close").hide()}});$("#dialog-termos").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,minHeight:500,resizable:!1,show:"fold",hide:"fold",buttons:{Ok:function(){$(this).dialog("close")}}});
$("#termos-click").click(function(){$("#dialog-termos").dialog("open");_gaq.push(["_trackEvent","Termos","Abrir"])});$("#dialog-como-funciona").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:550,minHeight:355,resizable:!1,show:"fold",hide:"fold",open:function(){$(".ui-dialog-titlebar-close ui-corner-all").attr("href","javascript:void(0)")}});$("#dialog-primeira-visita").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:550,minHeight:355,resizable:!1,show:"fold",hide:"fold",buttons:[{text:"Pular",
click:function(){$(this).dialog("close");_gaq.push(["_trackEvent","Apresenta\u00e7\u00e3o","Pular"])}}],open:function(){$(".ui-dialog-titlebar-close ui-corner-all").attr("href","javascript:void(0)");_gaq.push(["_trackEvent","Apresenta\u00e7\u00e3o","Abrir"])}});$("#como-funciona-click").click(function(){$("#dialog-como-funciona").dialog("open");_gaq.push(["_trackEvent","Como-funciona","Abrir"])});$("#dialog-blog").dialog({modal:!0,autoOpen:!1,draggable:!1,minWidth:500,minHeight:500,resizable:!1,show:"fold",
hide:"fold",open:function(){$(".ui-dialog-titlebar-close ui-corner-all").attr("href","javascript:void(0)")}});$("#blog-click").click(function(){$("#dialog-blog").dialog("open");_gaq.push(["_trackEvent","Blog","Abrir"])});criaHash=function(a){window.location.hash="#"+a;return!1};$("#logo-click").click(function(){carregaDenuncias();b.setCenter(e);b.setZoom(17);_gaq.push(["_trackEvent","Logo","Click"])});$("#urlShort").click(function(){this.select();_gaq.push(["_trackEvent","Den\u00fancias","Encurtador",
"Click"])});$("#carousel").rcarousel({auto:{enabled:!0,direction:"next",interval:1E4},width:300,height:45,visible:1,step:1});$(window).hashChange(q);checkPrimeiraVisita=function(){$.getJSON("/cidadaos/primeiraVisita",function(a){a.primeira&&$("#dialog-primeira-visita").dialog("open")})};checkPrimeiraVisita()});